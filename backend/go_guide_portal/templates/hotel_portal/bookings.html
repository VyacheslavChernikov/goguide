{% extends "hotel_portal/dashboard.html" %}

{% block content %}
<div class="page-title">Бронирования</div>

<!-- Filters -->
<div class="card-panel mb-3">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Статус</label>
      <select class="form-select" id="statusSelect">
        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Все</option>
        <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Подтверждённые</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Ожидают</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Дата с</label>
      <input type="date" class="form-control" id="dateFrom" value="{{ date_from }}" placeholder="дд.мм.гггг">
    </div>
    <div class="col-md-2">
      <label class="form-label">по</label>
      <input type="date" class="form-control" id="dateTo" value="{{ date_to }}" placeholder="дд.мм.гггг">
    </div>
    <div class="col-md-3">
      <a href="?export=csv{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
         class="btn-main w-100 text-center">
        <i class="fas fa-download me-1"></i>Экспорт CSV
      </a>
    </div>
  </div>
</div>

<!-- Bookings Table -->
<div class="card-panel">
  <div class="table-responsive">
    <table class="table table-dark table-hover table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Гость</th>
          <th>Номер</th>
          <th>Заезд</th>
          <th>Выезд</th>
          <th>Сумма</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in bookings %}
        <tr>
          <td>{{ booking.guest_name }}</td>
          <td>{{ booking.room.room_number }} ({{ booking.room.room_type }})</td>
          <td>{{ booking.date_from|date:"d.m.Y" }}</td>
          <td>{{ booking.date_to|date:"d.m.Y" }}</td>
          <td>{{ booking.total_price }} ₽</td>
          <td>
            {% if booking.is_confirmed %}
              <span class="badge bg-success">Подтверждено</span>
            {% else %}
              <span class="badge bg-warning text-dark">Ожидает</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editBooking({{ booking.id }})">
              <i class="fas fa-edit"></i> Изменить
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">Нет бронирований</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Booking Modal -->
<div class="modal fade" id="editBookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Редактировать бронирование</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="editBookingForm">
        {% csrf_token %}
        <input type="hidden" name="booking_id" id="bookingId">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Имя гостя</label>
              <input type="text" class="form-control" name="guest_name" id="guestName" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Телефон</label>
              <input type="tel" class="form-control" name="guest_phone" id="guestPhone">
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="guest_email" id="guestEmail">
            </div>
            <div class="col-md-6">
              <label class="form-label">Номер</label>
              <select class="form-select" name="room_id" id="roomId" required>
                {% for room in hotel.rooms.all %}
                <option value="{{ room.id }}">{{ room.room_number }} - {{ room.room_type }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Дата заезда</label>
              <input type="date" class="form-control" name="date_from" id="dateFrom" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Дата выезда</label>
              <input type="date" class="form-control" name="date_to" id="dateTo" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Стоимость</label>
              <input type="number" class="form-control" name="total_price" id="totalPrice" step="0.01" required>
            </div>
            <div class="col-md-6">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" name="is_confirmed" id="isConfirmed">
                <label class="form-check-label" for="isConfirmed">
                  Подтверждено
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById('statusSelect').addEventListener('change', function() {
  updateFilters();
});

document.getElementById('dateFrom').addEventListener('change', function() {
  updateFilters();
});

document.getElementById('dateTo').addEventListener('change', function() {
  updateFilters();
});

function updateFilters() {
  const status = document.getElementById('statusSelect').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;

  let url = `/dashboard/bookings/?status=${status}`;
  if (dateFrom) url += `&date_from=${dateFrom}`;
  if (dateTo) url += `&date_to=${dateTo}`;

  window.location.href = url;
}

function editBooking(bookingId) {
  // In a real implementation, you'd fetch booking data via AJAX
  // For now, just show the modal with sample data
  document.getElementById('bookingId').value = bookingId;

  // Sample data - in real app, fetch from server
  document.getElementById('guestName').value = 'Иван Иванов';
  document.getElementById('guestPhone').value = '+7 (999) 123-45-67';
  document.getElementById('guestEmail').value = 'ivan@example.com';
  document.getElementById('dateFrom').value = '2025-12-20';
  document.getElementById('dateTo').value = '2025-12-22';
  document.getElementById('totalPrice').value = '7000';
  document.getElementById('isConfirmed').checked = true;

  const modal = new bootstrap.Modal(document.getElementById('editBookingModal'));
  modal.show();
}
</script>
{% endblock %}
