{% extends "hotel_portal/dashboard.html" %}

{% block content %}
<div class="page-title">Аналитика</div>

<!-- Фильтр периода -->
<div class="card-panel mb-3">
  <div class="d-flex align-items-center gap-3 flex-wrap">
    <div class="text-uppercase fw-semibold" style="color: var(--muted); letter-spacing: 0.04em;">Период:</div>
    <div class="btn-group" role="group" aria-label="period">
      <a class="btn btn-sm btn-ghost {% if period == 'week' %}active text-light{% endif %}" href="/dashboard/analytics/?period=week">7д</a>
      <a class="btn btn-sm btn-ghost {% if period == 'month' %}active text-light{% endif %}" href="/dashboard/analytics/?period=month">14д</a>
      <a class="btn btn-sm btn-ghost {% if period == 'year' %}active text-light{% endif %}" href="/dashboard/analytics/?period=year">30д</a>
    </div>
  </div>
</div>

<!-- Метрики -->
<div class="row g-3 mb-3">
  <div class="col-lg-3 col-md-6">
    <div class="card-panel h-100">
      <div class="d-flex align-items-center gap-3">
        <div class="badge-soft px-3 py-2"><i class="fas fa-calendar-check"></i></div>
        <div>
          <div class="text-uppercase small" style="color: var(--muted);">Активные брони</div>
          <div class="fs-4 fw-bold">{{ total_bookings }}</div>
          <div class="small" style="color: var(--muted);">Текущие подтверждённые</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card-panel h-100">
      <div class="d-flex align-items-center gap-3">
        <div class="badge-soft px-3 py-2"><i class="fas fa-list"></i></div>
        <div>
          <div class="text-uppercase small" style="color: var(--muted);">Всего броней</div>
          <div class="fs-4 fw-bold">{{ total_bookings }}</div>
          <div class="small" style="color: var(--muted);">За период</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card-panel h-100">
      <div class="d-flex align-items-center gap-3">
        <div class="badge-soft px-3 py-2"><i class="fas fa-ruble-sign"></i></div>
        <div>
          <div class="text-uppercase small" style="color: var(--muted);">Доход</div>
          <div class="fs-4 fw-bold">{{ total_revenue }} ₽</div>
          <div class="small" style="color: var(--muted);">Подтверждённые</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card-panel h-100">
      <div class="d-flex align-items-center gap-3">
        <div class="badge-soft px-3 py-2"><i class="fas fa-chart-pie"></i></div>
        <div>
          <div class="text-uppercase small" style="color: var(--muted);">Загрузка</div>
          <div class="fs-4 fw-bold">{{ avg_occupancy }}%</div>
          <div class="small" style="color: var(--muted);">Средняя загрузка</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Графики -->
<div class="row g-3 mb-3">
  <div class="col-lg-8">
    <div class="card-panel h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Доход по дням</h6>
        <span class="small" style="color: var(--muted);">Подтверждённые</span>
      </div>
      <canvas id="revenueChart" height="180"></canvas>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card-panel h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Загрузка по номерам</h6>
        <span class="small" style="color: var(--muted);">За период</span>
      </div>
      <canvas id="roomsChart" height="180"></canvas>
    </div>
  </div>
</div>

<!-- Топ номеров -->
<div class="card-panel">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0">Топ номеров по доходу</h6>
    <span class="small" style="color: var(--muted);">Доход и бронирования</span>
  </div>
  <div class="table-responsive">
    <table class="table table-dark table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Номер</th>
          <th>Тип</th>
          <th>Выручка</th>
          <th>Бронирований</th>
        </tr>
      </thead>
      <tbody>
        {% for room in top_rooms %}
        <tr>
          <td>{{ room.room_number }}</td>
          <td>{{ room.room_type }}</td>
          <td>{{ room.revenue }} ₽</td>
          <td>{{ room.bookings }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted">Нет данных о номерах</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const revenueData = {{ revenue_data|safe }};
  const roomsData = {{ top_rooms|safe }};

  const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
  new Chart(ctxRevenue, {
    type: 'line',
    data: {
      labels: revenueData.map(item => item.date),
      datasets: [{
        label: 'Доход (₽)',
        data: revenueData.map(item => item.value),
        borderColor: '#27c2d3',
        backgroundColor: 'rgba(39, 194, 211, 0.12)',
        tension: 0.15,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#9fb4d3' },
          grid: { color: 'rgba(255,255,255,0.06)' }
        },
        x: {
          ticks: { color: '#9fb4d3' },
          grid: { display: false }
        }
      }
    }
  });

  const ctxRooms = document.getElementById('roomsChart').getContext('2d');
  new Chart(ctxRooms, {
    type: 'bar',
    data: {
      labels: roomsData.map(item => item.room_number),
      datasets: [{
        label: 'Бронирования',
        data: roomsData.map(item => item.bookings),
        backgroundColor: 'rgba(39, 194, 211, 0.7)',
        borderColor: '#1ea7b8',
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { color: '#9fb4d3' },
          grid: { color: 'rgba(255,255,255,0.06)' }
        },
        y: {
          ticks: { color: '#9fb4d3' },
          grid: { display: false }
        }
      }
    }
  });
});
</script>
{% endblock %}
