{% extends "go_guide_portal/base.html" %}
{% block content %}
<div class="flex items-center justify-between mb-4">
  <div>
    <h1 class="text-2xl font-semibold">–ù–æ–º–µ—Ä–∞</h1>
    <p class="text-muted text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–Ω—ã–º —Ñ–æ–Ω–¥–æ–º</p>
  </div>
  <button id="openCreateRoom" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">+ –î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<div class="bg-panel border border-white/5 rounded-xl overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="text-muted bg-white/5">
        <tr>
          <th class="text-left px-4 py-3">–§–æ—Ç–æ</th>
          <th class="text-left px-4 py-3">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th class="text-left px-4 py-3">–¢–∏–ø</th>
          <th class="text-left px-4 py-3">–¶–µ–Ω–∞</th>
          <th class="text-left px-4 py-3">–î–æ—Å—Ç—É–ø–Ω–∞</th>
          <th class="text-left px-4 py-3">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for room in services %}
        <tr class="border-t border-white/5">
          <td class="px-4 py-3">
            {% if room.photo_resolved_url %}
              <img src="{{ room.photo_resolved_url }}" alt="{{ room.title }}" class="h-16 w-16 object-cover rounded-md border border-white/10 bg-white/5 cursor-pointer preview-thumb" loading="lazy" data-full="{{ room.photo_resolved_url }}">
            {% else %}
              <div class="h-16 w-16 flex items-center justify-center rounded-md border border-dashed border-white/20 text-muted text-xs bg-white/5">
                üì∑ –ù–µ—Ç —Ñ–æ—Ç–æ
              </div>
            {% endif %}
          </td>
          <td class="px-4 py-3 font-medium">{{ room.title }}</td>
          <td class="px-4 py-3 text-muted">{{ room.service_type }}</td>
          <td class="px-4 py-3">{{ room.price }} ‚ÇΩ</td>
          <td class="px-4 py-3">
            {% if room.is_available %}
              <span class="px-2 py-1 rounded bg-green-500/20 text-green-200 text-xs">–î–æ—Å—Ç—É–ø–Ω–∞</span>
            {% else %}
              <span class="px-2 py-1 rounded bg-red-500/20 text-red-200 text-xs">–ó–∞–Ω—è—Ç–∞</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 space-x-2">
            <button
              class="px-3 py-2 text-xs rounded-lg bg-white/10 hover:bg-white/20 transition edit-room"
              data-id="{{ room.id }}"
              data-title="{{ room.title|escape }}"
              data-type="{{ room.service_type }}"
              data-price="{{ room.price|default_if_none:0|floatformat:'-2' }}"
              data-description="{{ room.description|default_if_none:''|escape }}"
              data-photo="{{ room.photo_url|default_if_none:''|escape }}"
              data-widget="{{ room.tour_widget|default_if_none:''|escape }}"
              data-available="{{ room.is_available|yesno:'true,false' }}"
              data-update-url="{% url 'room_update' room.id %}"
            >–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <form action="{% url 'room_delete' room.id %}" method="post" class="inline">
              {% csrf_token %}
              <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä?')" class="px-3 py-2 text-xs rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-100 transition">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="px-4 py-6 text-center text-muted">–ù–æ–º–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Create modal -->
<div id="createRoomModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-40 hidden">
  <div class="bg-panel border border-white/10 rounded-xl w-full max-w-xl p-6 relative">
    <button class="absolute top-3 right-3 text-muted hover:text-text" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    <h3 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä</h3>
    <form action="{% url 'room_create' %}" method="post" class="space-y-4">
      {% csrf_token %}
      <div>
        <label class="block text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        {{ form.title }}
      </div>
      <div>
        <label class="block text-sm mb-1">–¢–∏–ø</label>
        {{ form.service_type }}
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">–¶–µ–Ω–∞ –∑–∞ –Ω–æ—á—å</label>
          {{ form.price }}
        </div>
        <div class="flex items-center space-x-2 mt-6 md:mt-8">
          {{ form.is_available }}
          <span class="text-sm">–î–æ—Å—Ç—É–ø–Ω–∞</span>
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        {{ form.description }}
      </div>
      <div>
        <label class="block text-sm mb-1">URL —Ñ–æ—Ç–æ</label>
        {{ form.photo_url }}
        <p class="text-xs text-muted mt-1">–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://example.com/image.jpg). –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ freeimage.host ‚Äî –∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä—è–º–æ–π –ª–∏–Ω–∫ (CDN), –∞ –Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
      </div>
      <div>
        <label class="block text-sm mb-1">–í–∏–¥–∂–µ—Ç 360 / iframe</label>
        {{ form.tour_widget }}
        <p class="text-xs text-muted mt-1">–í—Å—Ç–∞–≤—å—Ç–µ HTML-–∫–æ–¥ –≤–∏–¥–∂–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GoGuide 360). –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å.</p>
      </div>
      <div class="flex justify-end space-x-3 pt-2">
        <button type="button" data-close class="px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit modal -->
<div id="editRoomModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-40 hidden">
  <div class="bg-panel border border-white/10 rounded-xl w-full max-w-xl p-6 relative">
    <button class="absolute top-3 right-3 text-muted hover:text-text" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    <h3 class="text-xl font-semibold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</h3>
    <form id="editRoomForm" action="#" method="post" class="space-y-4">
      {% csrf_token %}
      <div>
        <label class="block text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        <input type="text" name="title" id="editRoomTitle" required class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text placeholder-muted focus:outline-none focus:ring-2 focus:ring-accent" />
      </div>
      <div>
        <label class="block text-sm mb-1">–¢–∏–ø</label>
        <select name="service_type" id="editRoomType" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text focus:outline-none focus:ring-2 focus:ring-accent">
          {% for value,label in service_types %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">–¶–µ–Ω–∞ –∑–∞ –Ω–æ—á—å</label>
          <input type="number" step="0.01" min="0" name="price" id="editRoomPrice" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text focus:outline-none focus:ring-2 focus:ring-accent" />
        </div>
        <div class="flex items-center space-x-2 mt-6 md:mt-8">
          <input type="checkbox" name="is_available" id="editRoomAvailable" class="h-4 w-4 text-accent border-white/20 rounded" />
          <span class="text-sm">–î–æ—Å—Ç—É–ø–Ω–∞</span>
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea name="description" id="editRoomDescription" rows="3" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text placeholder-muted focus:outline-none focus:ring-2 focus:ring-accent"></textarea>
      </div>
      <div>
        <label class="block text-sm mb-1">URL —Ñ–æ—Ç–æ</label>
        <input type="url" name="photo_url" id="editRoomPhoto" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text placeholder-muted focus:outline-none focus:ring-2 focus:ring-accent" />
        <p class="text-xs text-muted mt-1">–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://example.com/image.jpg). –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ freeimage.host ‚Äî –∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä—è–º–æ–π –ª–∏–Ω–∫ (CDN), –∞ –Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
      </div>
      <div>
        <label class="block text-sm mb-1">–í–∏–¥–∂–µ—Ç 360 / iframe</label>
        <textarea name="tour_widget" id="editRoomWidget" rows="4" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text placeholder-muted focus:outline-none focus:ring-2 focus:ring-accent font-mono text-xs"></textarea>
      </div>
      <div class="flex justify-end space-x-3 pt-2">
        <button type="button" data-close class="px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const openCreate = document.getElementById('openCreateRoom');
    const createModal = document.getElementById('createRoomModal');
    const editModal = document.getElementById('editRoomModal');
    const editForm = document.getElementById('editRoomForm');

    const toggle = (el, show) => {
      if (!el) return;
      el.classList.toggle('hidden', !show);
    };

    if (openCreate && createModal) {
      openCreate.addEventListener('click', () => toggle(createModal, true));
    }

    document.querySelectorAll('[data-close]').forEach(btn => {
      btn.addEventListener('click', () => {
        toggle(createModal, false);
        toggle(editModal, false);
      });
    });

    document.querySelectorAll('.edit-room').forEach(btn => {
      btn.addEventListener('click', () => {
        const data = btn.dataset;
        if (!editForm) return;
        editForm.action = data.updateUrl;
        document.getElementById('editRoomTitle').value = data.title || '';
        document.getElementById('editRoomType').value = data.type || '';
        document.getElementById('editRoomPrice').value = data.price || '';
        document.getElementById('editRoomDescription').value = data.description || '';
        document.getElementById('editRoomPhoto').value = data.photo || '';
        document.getElementById('editRoomWidget').value = data.widget || '';
        document.getElementById('editRoomAvailable').checked = data.available === 'true';
        toggle(editModal, true);
      });
    });

    // Close modals on backdrop click
    [createModal, editModal].forEach(modal => {
      if (!modal) return;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) toggle(modal, false);
      });
    });
  })();
</script>
<script>
  // Preview overlay for room photos (shows over the page, not inside cell)
  (function() {
    const thumbs = document.querySelectorAll('.preview-thumb');
    if (!thumbs.length) return;

    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm p-4';
    overlay.innerHTML = `
      <div class="relative max-w-5xl max-h-[80vh]">
        <button aria-label="–ó–∞–∫—Ä—ã—Ç—å" class="absolute -top-3 -right-3 bg-black/60 text-white rounded-full h-8 w-8 flex items-center justify-center">√ó</button>
        <img src="" alt="preview" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl border border-white/10 object-contain" />
      </div>
    `;
    document.body.appendChild(overlay);
    const overlayImg = overlay.querySelector('img');
    const overlayClose = overlay.querySelector('button');

    let hoverTimer = null;

    const showOverlay = (src) => {
      overlayImg.src = src;
      overlay.classList.remove('hidden');
      overlay.classList.add('flex');
    };
    const hideOverlay = () => {
      overlay.classList.add('hidden');
      overlay.classList.remove('flex');
      overlayImg.src = '';
    };

    thumbs.forEach(img => {
      img.addEventListener('mouseenter', () => {
        const src = img.dataset.full;
        if (!src) return;
        hoverTimer = setTimeout(() => showOverlay(src), 250);
      });
      img.addEventListener('mouseleave', () => {
        if (hoverTimer) clearTimeout(hoverTimer);
      });
      img.addEventListener('click', (e) => {
        e.preventDefault();
        const src = img.dataset.full;
        if (src) showOverlay(src);
      });
    });

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) hideOverlay();
    });
    overlayClose.addEventListener('click', hideOverlay);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideOverlay();
    });
  })();
</script>
{% endblock %}

