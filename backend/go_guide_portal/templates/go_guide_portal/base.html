<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Go&Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {}
      }
    }
  </script>
  <style>
    body.theme-dark {
      --bg: #0A192F;
      --panel: #112240;
      --text: #E6F1FF;
      --muted: #8892B0;
      --accent: #64FFDA;
      --accent2: #FE7B54;
    }
    body.theme-light {
      --bg: #FFFFFF;
      --panel: #F5F7FA;
      --text: #0F172A;
      --muted: #475569;
      --accent: #2563EB;
      --accent2: #FE7B54;
    }
    body { background: var(--bg); color: var(--text); }
    .bg-bg { background: var(--bg); }
    .bg-panel { background: var(--panel); }
    .text-text { color: var(--text); }
    .text-muted { color: var(--muted); }
    .border-white\/5 { border-color: rgba(255,255,255,0.05); }
    .border-white\/10 { border-color: rgba(255,255,255,0.1); }
    .bg-accent { background: var(--accent); }
    .text-accent { color: var(--accent); }
    .bg-accent2 { background: var(--accent2); }
  </style>
</head>
<body class="bg-bg text-text min-h-screen {% if current_unit and current_unit.portal_theme == 'light' %}theme-light{% else %}theme-dark{% endif %}">
  {% with current_unit=current_unit|default_if_none:"" %}
  <div class="bg-bg text-text min-h-screen">
    <!-- Mobile header -->
    <div class="md:hidden flex items-center justify-between px-4 py-3 border-b border-white/5">
      <div class="text-lg font-semibold">Go&Guide</div>
      <button id="sidebarToggle" class="p-2 rounded-md hover:bg-white/10 focus:outline-none" aria-label="Открыть меню">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>

    <div class="flex min-h-screen relative">
      <!-- Sidebar -->
      <aside id="sidebar" class="hidden md:flex fixed inset-y-0 left-0 w-64 bg-panel border-r border-white/5 transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out z-50 flex-col">
        <div class="h-16 flex items-center px-6 text-xl font-semibold border-b border-white/5">
          Go&Guide
        </div>
        {% with active=request.resolver_match.url_name %}
        <nav class="flex-1 px-3 py-4 space-y-1 text-sm">
          {% if nav_items %}
            {% for item in nav_items %}
              <a href="{% url item.url_name %}"
                 class="flex items-center px-3 py-2 rounded-md hover:bg-white/10 transition {% if active == item.url_name %}bg-white/10 text-accent{% endif %}">
                <span aria-hidden="true">{% autoescape off %}{{ item.icon }}{% endautoescape %}</span>
                {{ item.label }}
              </a>
            {% endfor %}
          {% endif %}
        </nav>
        {% endwith %}
        <div class="p-4 border-t border-white/5">
          <a href="{% url 'logout' %}" class="flex items-center px-3 py-2 rounded-md hover:bg-white/10 transition">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H3m0 0l4-4m-4 4l4 4m4-10h5a2 2 0 012 2v8a2 2 0 01-2 2h-5"/></svg>
            Выйти
          </a>
        </div>
      </aside>

      <!-- Overlay for mobile -->
      <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-20 hidden md:hidden"></div>

      <!-- Content -->
      <main class="flex-1 md:ml-64 pl-4 pr-6 py-6 w-full bg-gray-900 min-h-screen">
        {% if messages %}
          <div class="fixed top-4 right-4 space-y-3 z-40">
            {% for message in messages %}
              <div class="px-4 py-3 rounded-lg shadow-lg border border-white/10
                          {% if message.tags == 'error' %}bg-red-500/20 text-red-100
                          {% elif message.tags == 'success' %}bg-accent/20 text-accent
                          {% else %}bg-panel text-text{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
          {% for message in messages %}
            {% if message.tags == 'error' %}
            <div class="fixed inset-0 z-40 flex items-center justify-center">
              <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
              <div class="relative bg-panel border border-white/10 rounded-xl p-6 w-full max-w-md shadow-2xl">
                <h3 class="text-xl font-semibold mb-2">Не удалось выполнить действие</h3>
                <p class="text-sm text-muted mb-4">{{ message }}</p>
                <div class="text-right">
                  <button class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20" onclick="this.closest('.fixed').remove()">Закрыть</button>
                </div>
              </div>
            </div>
            {% endif %}
          {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>
  {% endwith %}

  <script>
    (function() {
      const toggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      if (!toggle || !sidebar) return;

      const openSidebar = () => {
        sidebar.classList.remove('hidden', '-translate-x-full');
        sidebar.classList.add('flex');
        if (overlay) overlay.classList.remove('hidden');
      };
      const closeSidebar = () => {
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('flex');
        sidebar.classList.add('hidden');
        if (overlay) overlay.classList.add('hidden');
      };

      toggle.addEventListener('click', () => {
        const isHidden = sidebar.classList.contains('hidden') || sidebar.classList.contains('-translate-x-full');
        if (isHidden) {
          openSidebar();
        } else {
          closeSidebar();
        }
      });

      if (overlay) {
        overlay.addEventListener('click', closeSidebar);
      }

      // Auto-hide toasts
      const toasts = document.querySelectorAll('.fixed.top-4.right-4 .rounded-lg');
      if (toasts.length) {
        setTimeout(() => {
          toasts.forEach(t => t.classList.add('opacity-0', 'transition', 'duration-300'));
          setTimeout(() => toasts.forEach(t => t.remove()), 400);
        }, 3500);
      }
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>