{% extends "go_guide_portal/base.html" %}
{% load static %}
{% block content %}
<div class="flex items-center justify-between mb-4">
  <div>
    <h1 class="text-2xl font-semibold">Настройки</h1>
    <p class="text-muted text-sm">Основные параметры площадки и доступы</p>
  </div>
</div>

<div class="bg-panel border border-white/5 rounded-xl p-6">
  <div class="flex flex-wrap gap-2 mb-4">
    <button type="button" data-tab-btn="general" class="settings-tab-btn px-3 py-2 rounded-lg border border-white/10 bg-white/10 text-sm font-medium">Общее</button>
    <button type="button" data-tab-btn="payouts" class="settings-tab-btn px-3 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-medium">Выплаты</button>
    <button type="button" data-tab-btn="widget" class="settings-tab-btn px-3 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-medium">Виджет</button>
    <button type="button" data-tab-btn="security" class="settings-tab-btn px-3 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-medium">Безопасность</button>
  </div>

  <form method="post" action="{% url 'settings' %}" class="space-y-6" id="unitForm">
    {% csrf_token %}
    <input type="hidden" name="save_unit" value="1" />
    {{ unit_form.widget_config }}

    <div data-tab="general" class="settings-tab-content space-y-4">
      <h3 class="text-lg font-semibold">Площадка</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Название *</label>
          {{ unit_form.name }}
        </div>
        <div>
          <label class="block text-sm mb-1">Адрес</label>
          {{ unit_form.address }}
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Телефон</label>
          {{ unit_form.phone }}
        </div>
        <div>
          <label class="block text-sm mb-1">E-mail</label>
          {{ unit_form.email }}
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Сайт</label>
          {{ unit_form.website }}
        </div>
        <div>
          <label class="block text-sm mb-1">Соцсети/ссылки</label>
          {{ unit_form.socials }}
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Время открытия</label>
          {{ unit_form.working_hours_from }}
        </div>
        <div>
          <label class="block text-sm mb-1">Время закрытия</label>
          {{ unit_form.working_hours_to }}
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Чек-ин</label>
          {{ unit_form.checkin_time }}
        </div>
        <div>
          <label class="block text-sm mb-1">Чек-аут</label>
          {{ unit_form.checkout_time }}
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Парковка</label>
          {{ unit_form.parking_info }}
        </div>
        <div>
          <label class="block text-sm mb-1">Wi‑Fi</label>
          {{ unit_form.wifi_info }}
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Питание</label>
          {{ unit_form.meals_info }}
        </div>
        <div>
          <label class="block text-sm mb-1">Детская политика/опции</label>
          {{ unit_form.kids_policy }}
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Политика по питомцам</label>
          {{ unit_form.pets_policy }}
        </div>
        <div>
          <label class="block text-sm mb-1">Политика курения</label>
          {{ unit_form.smoke_policy }}
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">Доступность/инклюзивность</label>
        {{ unit_form.accessibility }}
      </div>
      <div>
        <label class="block text-sm mb-1">Координаты/проезд</label>
        {{ unit_form.coordinates }}
      </div>
      <div>
        <label class="block text-sm mb-1">УТП/позиционирование</label>
        {{ unit_form.positioning }}
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 items-center">
        <div>
          <label class="block text-sm mb-1">Тон ассистента</label>
          {{ unit_form.tone }}
        </div>
        <div class="flex items-center gap-2 mt-6 lg:mt-0">
          {{ unit_form.allow_emoji }}
          <span class="text-sm text-muted">Разрешать эмодзи в ответах</span>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Тема портала</label>
          {{ unit_form.portal_theme }}
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">Описание</label>
        {{ unit_form.description }}
      </div>
      <div>
        <label class="block text-sm mb-1">URL фото</label>
        {{ unit_form.photo_url }}
      </div>
      <div class="flex items-center justify-between bg-white/5 border border-white/10 rounded-lg px-3 py-2">
        <div>
          <div class="text-sm text-muted">API ключ</div>
          <div class="font-mono text-xs break-all">{{ unit.api_key }}</div>
        </div>
        <button type="button" onclick="navigator.clipboard.writeText('{{ unit.api_key }}')" class="text-xs px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">Копировать</button>
      </div>
      <div class="flex justify-end">
        <button type="submit" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">Сохранить</button>
      </div>
    </div>

    <div data-tab="payouts" class="settings-tab-content space-y-4 hidden">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div>
          <h3 class="text-lg font-semibold">Реквизиты и выплаты</h3>
          <p class="text-sm text-muted">Провайдер: {{ payout_provider|default:"manual" }}</p>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 w-full lg:w-auto">
          <div class="bg-white/5 border border-white/10 rounded-lg px-3 py-2">
            <div class="text-xs text-muted">Доступно</div>
            <div class="text-lg font-semibold">{{ balance.available|default:"0" }} ₽</div>
          </div>
          <div class="bg-white/5 border border-white/10 rounded-lg px-3 py-2">
            <div class="text-xs text-muted">В ожидании</div>
            <div class="text-lg font-semibold">{{ balance.reserved|default:"0" }} ₽</div>
          </div>
          <div class="bg-white/5 border border-white/10 rounded-lg px-3 py-2">
            <div class="text-xs text-muted">Выплачено</div>
            <div class="text-lg font-semibold">{{ balance.paid_out|default:"0" }} ₽</div>
          </div>
          <div class="bg-white/5 border border-white/10 rounded-lg px-3 py-2">
            <div class="text-xs text-muted">Оплачено бронирований</div>
            <div class="text-lg font-semibold">{{ balance.paid_total|default:"0" }} ₽</div>
          </div>
        </div>
      </div>

      <div class="border border-white/10 rounded-lg p-4 space-y-3">
        <h4 class="text-md font-semibold">Подключение провайдера</h4>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">Провайдер</label>
            {{ unit_form.payout_provider }}
          </div>
          <div>
            <label class="block text-sm mb-1">Режим</label>
            {{ unit_form.payout_mode }}
          </div>
          <div>
            <label class="block text-sm mb-1">ID / Public / TerminalKey</label>
            {{ unit_form.payout_provider_key }}
          </div>
          <div>
            <label class="block text-sm mb-1">Secret / API key</label>
            {{ unit_form.payout_provider_secret }}
          </div>
          <div>
            <label class="block text-sm mb-1">Секрет подписи вебхука</label>
            {{ unit_form.payout_webhook_secret }}
          </div>
          <div class="lg:col-span-2">
            <label class="block text-sm mb-1">Webhook URL</label>
            <div class="flex items-center gap-2">
              <input type="text" readonly value="{{ webhook_url }}" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text text-xs font-mono">
              <button type="button" onclick="navigator.clipboard.writeText('{{ webhook_url }}')" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm">Копировать</button>
            </div>
            <p class="text-xs text-muted mt-1">Добавьте этот URL в кабинете провайдера выплат.</p>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
          <p class="text-xs text-muted">После ввода ключей сохраните изменения. Можно выполнить тестовую выплату (mock/processing) для проверки связки.</p>
          <div class="flex gap-2">
            <button type="submit" name="create_test_payout" value="1" class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/10 text-sm">Тестовая выплата 1 ₽</button>
            <button type="submit" class="px-3 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 text-sm">Сохранить провайдера</button>
          </div>
        </div>
      </div>

      <div class="border border-white/10 rounded-lg p-4 space-y-3">
        <h4 class="text-md font-semibold">Создать выплату</h4>
        <p class="text-xs text-muted">Средства считаются из оплаченных бронирований. Провайдер по умолчанию: {{ payout_provider|default:"manual" }}.</p>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm mb-1">Сумма к выводу</label>
            {{ payout_form.amount }}
          </div>
          <div class="lg:col-span-2">
            <label class="block text-sm mb-1">Комментарий</label>
            {{ payout_form.comment }}
          </div>
        </div>
        <div class="flex justify-end">
          <button type="submit" name="create_payout" value="1" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">Вывести</button>
        </div>
      </div>

      <h4 class="text-md font-semibold pt-2">Реквизиты для выплат</h4>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Способ выплат</label>
          {{ unit_form.payout_method }}
        </div>
        <div>
          <label class="block text-sm mb-1">Р/с или карта (СБП)</label>
          {{ unit_form.payout_account }}
        </div>
        <div>
          <label class="block text-sm mb-1">Банк</label>
          {{ unit_form.payout_bank }}
        </div>
        <div>
          <label class="block text-sm mb-1">БИК</label>
          {{ unit_form.payout_bik }}
        </div>
        <div>
          <label class="block text-sm mb-1">ИНН</label>
          {{ unit_form.payout_inn }}
        </div>
        <div>
          <label class="block text-sm mb-1">КПП</label>
          {{ unit_form.payout_kpp }}
        </div>
        <div class="lg:col-span-2">
          <label class="block text-sm mb-1">Юр. наименование / ФИО</label>
          {{ unit_form.payout_name }}
        </div>
      </div>
      <p class="text-xs text-muted">Эти реквизиты используются для выводов. Проверьте корректность перед заявкой.</p>

      <div class="mt-4">
        <h4 class="text-md font-semibold mb-2">Последние выплаты</h4>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-muted bg-white/5">
              <tr>
                <th class="text-left px-3 py-2">Дата</th>
                <th class="text-left px-3 py-2">Сумма</th>
                <th class="text-left px-3 py-2">Комиссия</th>
                <th class="text-left px-3 py-2">Статус</th>
                <th class="text-left px-3 py-2">Провайдер</th>
                <th class="text-left px-3 py-2">ID</th>
              </tr>
            </thead>
            <tbody>
              {% for p in payouts %}
              <tr class="border-t border-white/5">
                <td class="px-3 py-2 whitespace-nowrap">{{ p.created_at }}</td>
                <td class="px-3 py-2">{{ p.amount }} {{ p.currency }}</td>
                <td class="px-3 py-2">{{ p.fee|default:"0" }}</td>
                <td class="px-3 py-2">
                  {% if p.status == 'paid' %}
                    <span class="px-2 py-1 rounded bg-green-500/20 text-green-200 text-xs">Выплачено</span>
                  {% elif p.status == 'processing' %}
                    <span class="px-2 py-1 rounded bg-blue-500/20 text-blue-100 text-xs">В обработке</span>
                  {% elif p.status == 'failed' %}
                    <span class="px-2 py-1 rounded bg-red-500/20 text-red-200 text-xs">Ошибка</span>
                  {% else %}
                    <span class="px-2 py-1 rounded bg-yellow-500/20 text-yellow-100 text-xs">На проверке</span>
                  {% endif %}
                </td>
                <td class="px-3 py-2">{{ p.get_provider_display }}</td>
                <td class="px-3 py-2 font-mono text-xs">{{ p.provider_payout_id|default:"—" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="px-3 py-3 text-center text-muted text-sm">Нет заявок на вывод.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div data-tab="widget" class="settings-tab-content space-y-6 hidden">
      <div class="border border-white/10 rounded-lg p-4">
        <h4 class="text-md font-semibold mb-2">Виджет бронирования (готовый код)</h4>
        <p class="text-sm text-muted mb-2">Скопируйте и вставьте на сайт клиента. Бизнес ID подставлен автоматически.</p>
        <div class="space-y-2">
          <textarea readonly class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text font-mono text-xs min-h-[120px]" id="embedCode">{{ embed_code }}</textarea>
          <div class="flex justify-end">
            <button type="button" onclick="navigator.clipboard.writeText(document.getElementById('embedCode').value)" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm">Скопировать</button>
          </div>
        </div>
      </div>

      <div class="border border-white/10 rounded-lg p-4 space-y-3" id="widget-configurator">
        <h4 class="text-md font-semibold">Настройка виджета (цвета и тексты)</h4>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="space-y-1">
            <span class="text-muted">Тема</span>
            <select id="presetTheme" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text">
              <option value="">Custom</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </label>
          <label class="space-y-1">
            <span class="text-muted">Ширина карточки</span>
            <input type="text" id="cfgWidth" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text" placeholder="например, 420px или 100%">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Фон</span>
            <input type="color" id="cfgPrimary" class="w-full h-10 bg-panel border border-white/10 rounded-lg">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Фон полей</span>
            <input type="color" id="cfgPanel" class="w-full h-10 bg-panel border border-white/10 rounded-lg">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Акцент</span>
            <input type="color" id="cfgAccent" class="w-full h-10 bg-panel border border-white/10 rounded-lg">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Текст</span>
            <input type="color" id="cfgText" class="w-full h-10 bg-panel border border-white/10 rounded-lg">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Подсказки</span>
            <input type="color" id="cfgMuted" class="w-full h-10 bg-panel border border-white/10 rounded-lg">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Граница</span>
            <input type="color" id="cfgBorder" class="w-full h-10 bg-panel border border-white/10 rounded-lg">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Скругление</span>
            <input type="text" id="cfgRadius" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text" placeholder="12px">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Шрифт</span>
            <input type="text" id="cfgFont" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text" placeholder="'Inter', sans-serif">
          </label>
          <label class="space-y-1">
            <span class="text-muted">Высота 360</span>
            <input type="text" id="cfgPreviewHeight" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text" placeholder="70vh">
          </label>
          <label class="space-y-1 col-span-2">
            <span class="text-muted">Текст кнопки</span>
            <input type="text" id="cfgSubmit" class="w-full px-3 py-2 rounded-lg bg-panel border border-white/10 text-text" placeholder="Забронировать">
          </label>
        </div>
        <div class="flex gap-3 items-center">
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="cfgHideEmail" class="h-4 w-4 text-accent border-white/20 rounded">
            <span class="text-muted">Скрыть email</span>
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="cfgAutoOpen" class="h-4 w-4 text-accent border-white/20 rounded">
            <span class="text-muted">Авто-открывать 360</span>
          </label>
        </div>
        <div class="flex gap-3 items-center">
          <button type="button" id="cfgApply" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm">Применить</button>
          <span class="text-xs text-muted">Изменения сохранятся вместе с площадкой.</span>
        </div>
      </div>

      <div class="flex justify-end">
        <button type="submit" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">Сохранить</button>
      </div>
    </div>
  </form>

  <div data-tab="security" class="settings-tab-content space-y-4 hidden">
    <form method="post" action="{% url 'settings' %}" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="change_password" value="1" />
      <div>
        <label class="block text-sm mb-1">Текущий пароль</label>
        {{ pwd_form.old_password }}
      </div>
      <div>
        <label class="block text-sm mb-1">Новый пароль</label>
        {{ pwd_form.new_password1 }}
      </div>
      <div>
        <label class="block text-sm mb-1">Повторите пароль</label>
        {{ pwd_form.new_password2 }}
      </div>
      <div class="flex justify-end">
        <button type="submit" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20">Сменить пароль</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'widget/widget-presets.js' %}"></script>
  <script src="{% static 'widget/configurator.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tabButtons = document.querySelectorAll('.settings-tab-btn');
      const tabContents = document.querySelectorAll('.settings-tab-content');

      const activateTab = (name) => {
        tabContents.forEach((content) => {
          content.classList.toggle('hidden', content.dataset.tab !== name);
        });
        tabButtons.forEach((btn) => {
          const isActive = btn.dataset.tabBtn === name;
          btn.classList.toggle('bg-accent', isActive);
          btn.classList.toggle('text-bg', isActive);
          btn.classList.toggle('border-accent', isActive);
          btn.classList.toggle('bg-white/10', !isActive);
          btn.classList.toggle('bg-white/5', !isActive);
        });
      };

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tabBtn));
      });

      // Активируем первую вкладку по умолчанию
      if (tabButtons.length) {
        activateTab(tabButtons[0].dataset.tabBtn);
      }
    });
  </script>
{% endblock %}

