{% extends "go_guide_portal/base.html" %}
{% block content %}
<div class="space-y-6">
  <div class="bg-panel border border-white/5 rounded-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-semibold">AI-ассистент</h1>
        <p class="text-muted text-sm">Подключите GigaChat, чтобы ассистент отвечал.</p>
      </div>
      <a href="{% url 'gigachat_settings' %}" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">
        Подключить GigaChat
      </a>
    </div>
    <p class="text-sm text-muted">Перейдите в раздел интеграций, введите Client ID и Authorization key, затем вернитесь сюда для работы с чатом.</p>
  </div>

  <div class="bg-panel border border-white/5 rounded-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">База знаний</h2>
      <form method="post" enctype="multipart/form-data" class="flex items-center gap-3">
        {% csrf_token %}
        <input type="hidden" name="upload_knowledge" value="1" />
        <input type="file" name="knowledge_file" accept=".txt,.pdf" class="text-sm text-muted file:mr-3 file:px-3 file:py-2 file:rounded-lg file:border-none file:bg-white/10 file:text-text hover:file:bg-white/20">
        <button type="submit" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">Добавить знания</button>
      </form>
    </div>
    {% if knowledge_docs %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-muted bg-white/5">
            <tr>
              <th class="text-left px-4 py-2">Файл</th>
              <th class="text-left px-4 py-2">Статус</th>
              <th class="text-left px-4 py-2">Загружен</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in knowledge_docs %}
            <tr class="border-t border-white/5">
              <td class="px-4 py-2">{{ doc.original_name }}</td>
              <td class="px-4 py-2">
                {% if doc.status == 'processed' %}
                  <span class="px-2 py-1 rounded bg-green-500/20 text-green-200 text-xs">Обработан</span>
                {% elif doc.status == 'failed' %}
                  <span class="px-2 py-1 rounded bg-red-500/20 text-red-200 text-xs">Ошибка</span>
                {% else %}
                  <span class="px-2 py-1 rounded bg-yellow-500/20 text-yellow-100 text-xs">Ожидает обработки</span>
                {% endif %}
              </td>
              <td class="px-4 py-2">{{ doc.uploaded_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted text-sm">Загруженных файлов пока нет.</p>
    {% endif %}
  </div>

  <div class="bg-panel border border-white/5 rounded-xl p-6">
    <h2 class="text-lg font-semibold mb-3">Чат с AI-ассистентом</h2>
    <div id="message-list" class="h-80 overflow-y-auto bg-white/5 border border-white/5 rounded-lg p-4 space-y-3 mb-4" style="scroll-behavior: smooth;">
      {% if chat_history %}
        {% for msg in chat_history %}
          {% if msg.role == 'user' %}
            <div class="flex justify-end">
              <div class="max-w-xl px-4 py-2 rounded-lg bg-accent text-bg shadow">{{ msg.content }}</div>
            </div>
          {% else %}
            <div class="flex justify-start">
              <div class="max-w-xl px-4 py-2 rounded-lg bg-white/10 text-text shadow">{{ msg.content }}</div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <p class="text-muted text-sm">Сообщений пока нет.</p>
      {% endif %}
    </div>
    <form method="post" id="chat-form" action="{% url 'ai_assistant' %}" class="flex items-center gap-3">
      {% csrf_token %}
      <input type="hidden" name="chat_message_flag" value="1" />
      <textarea id="chat-input" name="chat_message" rows="2" placeholder="Задайте вопрос ассистенту..." class="flex-1 px-3 py-2 rounded-lg bg-panel border border-white/10 text-text placeholder-muted focus:outline-none focus:ring-2 focus:ring-accent"></textarea>
      <button type="submit" class="px-4 py-2 rounded-lg bg-accent text-bg font-medium hover:bg-accent/80 transition">Отправить</button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const messageList = document.getElementById('message-list');

    // Автопрокрутка к последнему сообщению
    const scrollToBottom = () => {
      if (!messageList) return;
      const last = messageList.lastElementChild;
      if (last) {
        last.scrollIntoView({ behavior: 'auto', block: 'end' });
      } else {
        messageList.scrollTop = messageList.scrollHeight;
      }
    };
    // несколько попыток после загрузки, чтобы точно проскроллить
    scrollToBottom();
    setTimeout(scrollToBottom, 50);
    setTimeout(scrollToBottom, 150);
    window.addEventListener('load', () => {
      scrollToBottom();
      setTimeout(scrollToBottom, 50);
      setTimeout(scrollToBottom, 150);
    });

    // Следим за новыми сообщениями и доскролливаем
    if (messageList) {
      const observer = new MutationObserver(() => scrollToBottom());
      observer.observe(messageList, { childList: true, subtree: true });
    }

    if (!form) return;

    const createBubble = (role, text) => {
      const wrapper = document.createElement('div');
      wrapper.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';
      const bubble = document.createElement('div');
      bubble.className =
        'max-w-xl px-4 py-2 rounded-lg shadow ' +
        (role === 'user' ? 'bg-accent text-bg' : 'bg-white/10 text-text');
      bubble.textContent = text;
      wrapper.appendChild(bubble);
      return wrapper;
    };

    const appendMessage = (role, text) => {
      if (!messageList || !text) return;
      const bubble = createBubble(role, text);
      messageList.appendChild(bubble);
      scrollToBottom();
    };

    // Отправка по Enter (Shift+Enter — новая строка)
    if (input) {
      input.focus();
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.click();
        }
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const actionUrl = form.getAttribute('action') || window.location.pathname;
      const formData = new FormData(form);
      const userText = input ? input.value.trim() : "";
      if (!userText) return;

      // оптимистично добавляем сообщение пользователя
      appendMessage('user', userText);
      if (input) input.value = "";

      try {
        const resp = await fetch(actionUrl, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: formData,
          credentials: 'same-origin',
        });
        if (resp.ok) {
          const data = await resp.json();
          if (data.reply) appendMessage('assistant', data.reply);
        } else {
          console.error('Chat request failed', resp.status);
        }
      } catch (err) {
        console.error('Chat request error', err);
      }
    });
  });
</script>
{% endblock %}

